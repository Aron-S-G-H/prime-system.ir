{% load humanize %}

<div class="offcanvas-header border-bottom border-1 border-muted">
    <h5 class="offcanvas-title">سبد خرید</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
</div>
<div class="offcanvas-body">
    <div class="row">
        {% for item in cart %}
        <div class="col-12">
            <div class="row align-items-center">
                <div class="col-11">
                    <a href="{% url 'product:detail' item.product.slug %}">
                        <div class="product-row bg-white d-flex align-items-center justify-content-between rounded-4 shadow-md">
                            <div class="image">
                                <img src="{{ item.product.images.first.image.url }}" loading="lazy" class="img-fluid" width="100" alt="{{ item.product.slug }}">
                            </div>
                            <div class="desc">
                                <h6 class="font-14 title text-overflow">{{ item.product.name }}</h6>
                                <div class="price d-flex flex-column justify-content-end mt-2">
                                    {% if item.discount_percent %}
                                        <div class="text-end">
                                            <span class="fw-bold font-18 def-color">{{ item.product.special_price|intcomma:False }}</span>
                                            <span class="badge main-color-two-bg rounded-pill">{{ item.discount_percent }}%</span>
                                        </div>
                                        <div class="text-end">
                                            <span class="text-muted font-14 text-decoration-line-through">{{ item.product.base_price|intcomma:False }}</span>
                                            <span class="text-muted font-14">تومان</span>
                                        </div>
                                    {% else %}
                                        <div class="text-end">
                                            <span class="fw-bold font-18 def-color">{{ item.total|intcomma:False }}</span>
                                            <span class="text-muted font-14">تومان</span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-1 ps-0">
                    <a role="button" onclick="removeFromCart('{{ item.unique_id }}')" data-hint="حذف از سبد" class="hint--right">
                        <i class="bi bi-x-circle-fill text-danger fs-4"></i>
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
        <div class="mt-3 d-flex justify-content-around">
            <a href="{% url 'cart:detail' %}" class="btn border-0 main-color-one-bg waves-effect waves-light">سبد خرید</a>
            {% if request.user.is_authenticated %}
                {% if cart.cart_quantity %}
                    <a href="{% url 'cart:checkout' %}" class="btn border-0 main-color-three-bg waves-effect waves-light">تسویه حساب</a>
                {% else %}
                    <button disabled class="btn border-0 main-color-three-bg waves-effect waves-light">تسویه حساب</button>
                {% endif %}
            {% else %}
                <a href="{% url 'account:login' %}?next={% url 'cart:detail' %}" class="btn border-0 btn-warning waves-effect waves-light">ورود به حساب کاربری</a>
            {% endif %}
        </div>
    </div>
</div>
<script>
    function removeFromCart(uniqueID){
        $.ajax({
            url: `/cart/remove/${uniqueID}`,
            type: 'GET',
            success: function (response) {
                if (response.status === 200){
                    window.location.reload();
                }
            },
            error: function (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'خطایی رخ داده است! وضعیت اینترنت خود را بررسی کنید و دوباره امتحان کنید. در صورت برطرف نشدن مشکل با پشتیبانی تماس بگیرید.',
                    confirmButtonColor: '#3085d6',
                })
                console.log(error)
            }
        })
    }
</script>