{% extends 'templates/base.html' %}
{% load static %}
{% load jalali_tags %}

{% block header %}
    <meta name="description" content="{{ blog.meta_description }}"/>
    <meta name="robots" content="index, follow" />
    <meta name="canonical" content="https://prime-system.ir/blogs/detail/{{ blog.slug }}" />
    <meta name="keywords" content="{{ blog.meta_keyword }}"/>
    <title>{{ blog.title }}</title>
{% endblock %}

{% block main %}
    <!-- bread croumb -->
    <div class="content">
        <div class="container-fluid">
            <nav aria-label="breadcrumb" class="my-lg-0 my-2">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'main:Home_page' %}" class="font-14 text-muted">خانه</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'blog:list' %}" class="font-14 text-muted">وبلاگ</a></li>
                    <li class="breadcrumb-item active main-color-one-color font-14" aria-current="page">{{ blog.title }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- start main-data -->
    <div class="content">
        <div class="container-fluid">
            <div class="row gy-2">
                <div class="col-lg-12 order-lg-2 order-1">
                    <div class="content-box">
                        <div class="row gy-2">
                            <div class="col-12">
                                <div class="blog-detail-title mb-4">
                                    <h1 class="main-title">{{ blog.title }}</h1>
                                </div>
                            </div>
                            <div class="col-lg-5">
                                <div class="shadow-box">
                                    <img src="{{ blog.poster.poster.url }}" alt="{{ blog.slug }}" class="img-fluid rounded-3">
                                </div>
                            </div>
                            <div class="col-lg-7">
                                <div class="blog-meta w-100">
                                    <ul class="navbar-nav flex-row w-100 justify-content-around">
                                        <li class="nav-item">
                                            <div class="item">
                                                <div class="title d-grid gap-2">
                                                    <h6 class="font-12 text-muted fw-normal">دسته بندی</h6>
                                                    <h6 class="font-16">{{ blog.category.name }}</h6>
                                                </div>
                                            </div>
                                        </li>
                                        <li class="nav-item">
                                            <div class="item">
                                                <div class="d-flex align-items-center">
                                                    <div class="icon">
                                                        <div class="box-icon rounded-circle" style="width: 50px; height:50px ;">
                                                            <i class="bi bi-person fs-3 main-color-one-color"></i>
                                                        </div>
                                                    </div>
                                                    <div class="title d-grid gap-2">
                                                        <h6 class="font-12 text-muted fw-normal">نویسنده</h6>
                                                        <h6 class="font-16">{{ blog.author }}</h6>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                        <li class="nav-item">
                                            <div class="item">
                                                <div class="title d-grid gap-2">
                                                    <div class="d-flex justify-content-center">
                                                        <h6 class="font-12 text-muted badge rounded-pill bg-light fw-normal py-2">متوسط امتیاز ها</h6>
                                                    </div>
                                                    <h6 class="font-16 text-center">{{ blog.average_rating }}</h6>
                                                </div>
                                            </div>
                                        </li>
                                        <li class="nav-item">
                                            <div class="item">
                                                <div class="title d-grid gap-2">
                                                    <div class="d-flex justify-content-center">
                                                        <h6 class="font-12 text-muted badge rounded-pill bg-light fw-normal py-2">دیدگاه ها</h6>
                                                    </div>
                                                    <h6 class="font-16 text-center">{{ blog.comments.count }} دیدگاه</h6>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                <div class="blog-desc-short font-14 bg-light p-4 shadow-box text-justify rounded-4 my-3">
                                    <p>{{ blog.introduction }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="blog-desc">
                            {{ blog.description|safe }}
                        </div>
                        <div class="blog-desc-tag my-3">
                            <h3 class="font-16 mb-2"><i class="bi bi-tag me-1"></i>برجسب ها</h3>
                            <div class="d-flex align-items-center flex-wrap">
                                {% for tag in blog.tags.all %}
                                    <div class="blog-tag">
                                        <a href="{% url 'blog:list' %}?tag={{ tag.slug }}">{{ tag.name }}</a>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="blog-desc-tag my-3">
                            <h3 class="font-16 mb-2"><i class="bi bi-folder me-1"></i>دسته بندی</h3>
                            <div class="d-flex align-items-center flex-wrap">
                                <div class="blog-tag">
                                    <a href="{% url 'blog:list' %}?category={{ blog.category.slug }}">{{ blog.category.name }}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- end main-data -->

    <!-- start slider -->
    {% if related_blogs %}
    <div class="content">
        <div class="product-box blog-box">
            <div class="container-fluid">
                <div class="parent">
                    <div class="content-title">
                        <div class="item">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                class="bi bi-box-seam" viewBox="0 0 16 16">
                                <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5l2.404.961L10.404 2l-2.218-.887zm3.564 1.426L5.596 5 8 5.961 14.154 3.5l-2.404-.961zm3.25 1.7-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"></path>
                            </svg>
                            <h5 class="title">سایر مقالات</h5>
                        </div>
                        <div class="item">
                            <i class="bi bi-box-arrow-in-left"></i>
                            <a href="{% url 'blog:list' %}">
                                <h5 class="title">مشاهده همه</h5>
                            </a>
                        </div>
                    </div>
                    <div class="swiper py-5" id="swiper-box-two">
                        <div class="swiper-wrapper">
                            {% for blog in related_blogs %}
                                <div class="swiper-slide">
                                    <a href="{% url 'blog:detail' blog.slug %}" title="{{ blog.english_title }}">
                                        <div class="image-blog text-center">
                                            <img src="{{ blog.poster.poster.url }}" class="img-fluid" alt="{{ blog.slug }}" loading="lazy">
                                            <div class="blog-desc position-absolute bottom-0">
                                                <h6 class="font-14">{{ blog.title }}</h6>
                                                <div class="d-flex justify-content-between align-items-center my-2">
                                                    <div class="like">
                                                        <span class="icon">
                                                            <i class="bi bi-box-seam"></i>
                                                        </span>
                                                        <span class="counter font-12">{{ blog.category.name }}</span>
                                                    </div>
                                                    <div class="date d-flex align-items-center">
                                                        <div class="icon me-1"><i class="bi bi-calendar-event"></i></div>
                                                        <span class="font-12">{{ blog.created_at|to_jalali:'%Y/%m/%d' }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="swiper-pagination"></div>
                        <div class="swiper-button-next d-sm-flex d-none"></div>
                        <div class="swiper-button-prev d-sm-flex d-none"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- end slider -->

    <!-- FORM -->
    <div class="content">
        <div class="container-fluid">
            <div class="content-box">
                <div class="comment-form py-20">
                    <h6 class="font-16">نظرت در مورد این مطلب چیه؟</h6>
                    {% if not request.user.is_authenticated %}
                        <p class="font-14 main-color-two-color mt-2">برای ثبت نظر، لطفا ابتدا <a style="text-decoration: underline" href="{% url 'account:login' %}">وارد حساب کاربری</a> خود شوید !</p>
                    {% else %}
                        <p class="font-14 text-muted mt-2">برای ثبت نظر، از طریق دکمه ثبت نظر اقدام نمایید، نظر شما به ما در بهبود کیفیت مطالب کمک فراوان میکند.</p>
                        <div class="row justify-content-center">
                            <div class="col-md-8">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="form-group">
                                            <label for="commentRating" class="my-3">امتیاز شما</label>
                                            <fieldset class="rating">
                                                <input type="radio" id="star5" name="rating" value="5" required />
                                                <label for="star5">5 stars</label>
                                                <input type="radio" id="star4" name="rating" value="4" required />
                                                <label for="star4">4 stars</label>
                                                <input type="radio" id="star3" name="rating" value="3" required />
                                                <label for="star3">3 stars</label>
                                                <input type="radio" id="star2" name="rating" value="2" required />
                                                <label for="star2">2 stars</label>
                                                <input type="radio" id="star1" name="rating" value="1" required />
                                                <label for="star1">1 star</label>
                                            </fieldset>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-floating">
                                            <textarea class="form-control" id="floatingTextarea2" style="height: 150px"></textarea>
                                            <label for="floatingTextarea2">متن نظر!</label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <button id="submit-comment" class="btn w-100 border-0 main-color-three-bg my-3 mx-auto d-block waves-effect waves-light">ثبت نظر</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
                {% if blog.comments.all %}
                    {% for comment in blog.comments.all %}
                        <div class="comment bg-light shadow-inner mb-4">
                            <div class="title">
                                <div class="row align-items-center">
                                    <div class="col-sm-10">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar p-2 bg-white shadow-box rounded-circle">
                                                <img src="{% static 'image/user-profile.png' %}" alt="user-profile" class="img-fluid rounded-circle">
                                            </div>
                                            <div class="d-flex flex-wrap align-items-center ms-2">
                                                <h6 class="text-muted font-14">{{ comment.user }}</h6>
                                                <h6 class="text-muted font-14 ms-2">{{ comment.created_at|to_jalali:"%Y/%m/%d" }}</h6>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-2">
                                        <div class="d-flex star justify-content-end">
                                            {% for i in range %}
                                                {% if i <= comment.rating %}
                                                    <i class="bi bi-star-fill"></i>
                                                {% else %}
                                                    <i class="bi bi-star"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="desc py-3">
                                <p class="font-14 text-muted">{{ comment.text }}</p>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
 <!-- end FORM -->
    {% if request.user.is_authenticated %}
        <script>
            let ratingValue = 5;
            const textArea = document.querySelector('textarea');
            const submitComment = document.getElementById('submit-comment');
            document.querySelectorAll('input[name="rating"]').forEach((radio) => {
                radio.addEventListener('change', (Event) => {
                    ratingValue = Event.target.value;
                })
            });
            function toggleFormState(isDisabled) {
                textArea.disabled = isDisabled;
                submitComment.disabled = isDisabled;
                if (!isDisabled) {
                    textArea.value = '';
                }
            }
            submitComment.addEventListener('click', () => {
                if (textArea.value && ratingValue > 0) {
                    toggleFormState(true);
                    $.ajax({
                        url: '{% url "blog:detail" blog.slug %}',
                        type: 'POST',
                        data: {
                            'text': textArea.value,
                            'rating': ratingValue,
                        },
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
                        },
                        success: function (response) {
                            if (response.status === 400) {
                                Swal.fire({
                                    icon: 'error',
                                    text: response.error_message,
                                    confirmButtonColor: '#3085d6',
                                });
                            }
                            else if (response.status === 200) {
                                Swal.fire({
                                    position: 'top-start',
                                    icon: 'success',
                                    title: 'نظر شما با موفقیت ثبت شد',
                                    showConfirmButton: false,
                                    timer: 1500
                                }).then(() => {
                                    window.location.reload()
                                })
                            }
                        },
                        error: function (err) {
                            Swal.fire({
                                icon: 'error',
                                title: err.code,
                                text: 'خطایی رخ داده است! وضعیت اینترنت خود را بررسی کنید و دوباره امتحان کنید. در صورت برطرف نشدن مشکل با پشتیبانی تماس بگیرید.',
                                confirmButtonColor: '#3085d6',
                            })
                            console.log(err)
                        }
                    });
                    toggleFormState(false);
                } else {
                    textArea.focus();
                }
            })
        </script>
    {% endif %}
{% endblock %}