{% extends 'templates/base.html' %}

{% block header %}
    <meta name="description" content="صفحه ورود و لاگین کاربر به وبسایت فروشگاهی تجهیزات الکترونیک پرایم سیستم"/>
    <meta name="robots" content="index, follow" />
    <meta name="canonical" content="https://prime-system.ir/accounts/login" />
    <meta name="keywords" content="پرایم سیستم, prime system, فروشگاه آنلاین پرایم سیستم, خرید تجهیزات الکترونیک,استوک و نو, فروش لپ‌تاپ, فروش قطعات کامپیوتر, prime system shop"/>
    <title>ورود به فروشگاه</title>
{% endblock %}

{% block main %}
    <!-- bread croumb -->
    <div class="content">
        <div class="container-fluid">
            <nav aria-label="breadcrumb" class="my-lg-0 my-2">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'main:Home_page' %}" class="font-14 text-muted">خانه</a></li>
                    <li class="breadcrumb-item active main-color-one-color font-14" aria-current="page">ورود</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- start main-data -->
    <div class="content">
        <div class="container-fluid">
            <div class="content-box">
                <div class="row justify-content-center">
                    <div class="col-lg-6 col-xl-4 col-sm-8">
                        <div class="auth shadow-box rounded-4 p-4">
                            <div class="auth-content">
                                <h3 class="font-20 text-center auth-title-form">ورود به فروشگاه</h3>
                                <form id="login-form" class="mt-3">
                                    <div class="form-floating mb-3">
                                        {{ login_form.phone }}
                                        <label for="floatingInput">تلفن همره</label>
                                    </div>
                                    <div class="form-floating mb-3">
                                        {{ login_form.password }}
                                        <label for="floatingPassword">کلمه عبور</label>
                                    </div>
                                    <div class="row gy-3 mb-3">
                                        <div class="col-sm-12">
                                            <div class="form-group text-start">
                                                <a href="{% url 'account:forget_password' %}" class="text-primary">فراموشی رمز عبور</a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <button id="submit-login-form" class="btn main-color-three-bg border-0 rounded-pill w-100 text-white waves-effect waves-light">ورود</button>
                                    </div>
                                </form>
                                <div class="divider">
                                    <span>یا</span>
                                </div>
                                <div class="d-flex justify-content-center">
                                    <a href="{% url 'account:register' %}">عضو نیستی؟ ثبت نام در فروشگاه</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- end main-data -->
    <script>
        const loginForm = document.getElementById('login-form');
        const phoneInput = document.getElementById('floatingInput');
        const passwordInput = document.getElementById('floatingPassword');
        const submitBtn = document.getElementById('submit-login-form');

        function login(phone, password){
            $.ajax({
                url: '{% url "account:login" %}',
                type: 'POST',
                data: {
                    'phone': phone,
                    'password': password,
                },
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
                },
                success: function (response) {
                    if (response.status === 400) {
                        Swal.fire({
                            icon: 'error',
                            title: 'خطای ۴۰۰',
                            text: `${response.error_message}`,
                            confirmButtonColor: '#3085d6',
                        })
                    }
                    else if (response.status === 401) {
                        Swal.fire({
                            icon: 'error',
                            title: 'ناموفق',
                            text: 'کاربری با این مشخصات یافت نشد. رمز یا شماره همراه نامعتبر است.',
                            confirmButtonColor: '#3085d6',
                        })
                    }
                    else if (response.status === 200){
                        Swal.fire({
                            position: 'top-start',
                            icon: 'success',
                            title: `${response.first_name} ${response.last_name} خوش آمدی `,
                            showConfirmButton: false,
                            timer: 1500
                        }).then(() => {
                            let urlParams = new URLSearchParams(window.location.search)
                            if (urlParams.has('next')) {
                                let next_page = urlParams.get('next');
                                window.location.assign(next_page)
                            }else{
                                window.location.assign('/')
                            }
                        })
                    }
                    loginForm.querySelectorAll('input, button').forEach(el => el.disabled = false);
                },
                error: function (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'خطایی رخ داده است! وضعیت اینترنت خود را بررسی کنید و دوباره امتحان کنید. در صورت برطرف نشدن مشکل با پشتیبانی تماس بگیرید.',
                        confirmButtonColor: '#3085d6',
                    })
                    console.log(error)
                    loginForm.querySelectorAll('input, button').forEach(el => el.disabled = false);
                }
            })
        }
        submitBtn.addEventListener('click', event => {
            event.preventDefault();
            let phone = phoneInput.value;
            let password = passwordInput.value;
            if (!phone){
                phoneInput.focus();
            }
            else if (!password){
                passwordInput.focus();
            }
            else {
                loginForm.querySelectorAll('input, button').forEach(el => el.disabled = true);
                login(phone, password);
            }
        })
    </script>
{% endblock %}